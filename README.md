# powertop-to-tmpfile

Apply [PowerTOP](https://github.com/fenrus75/powertop) recommendations via a tmpfiles.d configuration file.

This is a bash script to convert a `powertop.csv` into [`systemd-tmpfiles` format](https://www.freedesktop.org/software/systemd/man/latest/tmpfiles.d.html), which can be easily edited and applied on boot.

## Usage

### Recommended workflow

```bash
# Reboot if you have run powertop before to restore the default configuration
sudo reboot

# Collect the PowerTOP recommendations into file ‘powertop.csv‘
sudo powertop --csv=powertop.csv

# Convert the powertop.csv to a tmpfile
powertop-to-tmpfile --csv powertop.csv |sudo tee -a /etc/tmpfiles.d/powertop.conf

# Review the file /etc/tmpfiles.d/powertop.conf and remove entries you don't want.
# e.g. a wireless mouse or keyboard may not work well with the powertop recommendations

# Activate the generated tmpfile (or reboot)
sudo systemd-tmpfiles --create /etc/tmpfiles.d/powertop.conf
```

### Automatic mode

The automatic workflow works similar the powertop `--auto-tune` option and directly activates all recommendations. These are persisted in file `/etc/tmpfiles.d/powertop.conf` and activated on boot.

```bash
# Example execution of the `powertop-to-tmpfile --auto-tune` command
$ sudo powertop-to-tmpfile --auto-tune

Running powertop.. (This will take a while.)
+ powertop --csv=/tmp/tmp.SyTyFr3zyS/powertop.csv

Creating tmpfiles.d configuration: /etc/tmpfiles.d/powertop.conf
## Generated by powertop-to-tmpfile at 2024-04-09 14:10:07 CEST
# NMI watchdog should be turned off
w   /proc/sys/kernel/nmi_watchdog   -   -   -   -   0
# VM writeback timeout
w   /proc/sys/vm/dirty_writeback_centisecs   -   -   -   -   1500

Activating tmpfiles.d configuration: /etc/tmpfiles.d/powertop.conf
+ systemd-tmpfiles --create /etc/tmpfiles.d/powertop.conf

All done.
```

## Caveat

A `systemd-tmpfile` is not the _correct_ way to apply device configuration. This would be to use `udev` rules or module configuration. That said, generating a tmpfile from the `powertop.csv` is fairly simple and works well for a static device configuration. If you have changing devices or devices only added after boot, you want to use a different mechanism to apply the powerTOP recommendations.
